{% extends 'base.html' %} {% load static %} {% block content %}
<div class="max-w-4xl mx-auto px-4 py-8">
  <div class="bg-white rounded-2xl shadow-card p-8">
    <h1 class="text-3xl font-black text-gray-900 mb-6">Procesar Pago</h1>

    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
      <!-- Order Summary -->
      <div class="space-y-4">
        <h2 class="text-xl font-bold text-gray-800">Resumen del Pedido</h2>
        <div class="bg-gray-50 p-6 rounded-xl space-y-3">
          <div class="flex justify-between text-gray-600">
            <span>Subtotal</span>
            <span class="font-medium">${{ amount }}</span>
          </div>
          <div class="flex justify-between text-gray-600">
            <span>Envío</span>
            <span class="font-medium">Gratis</span>
          </div>
          <div class="h-px bg-gray-200 my-2"></div>
          <div class="flex justify-between text-xl font-black text-xiaomi">
            <span>Total</span>
            <span>${{ amount }}</span>
          </div>
        </div>
        <p class="text-sm text-gray-500">
          Al completar la compra, aceptas nuestros términos y condiciones.
        </p>
      </div>

      <!-- Payment Options -->
      <div class="space-y-6">
        <h2 class="text-xl font-bold text-gray-800">Método de Pago</h2>

        <div id="paypal-button-container" class="w-full"></div>
      </div>
    </div>
  </div>
</div>

<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD"></script>

<script>
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== "") {
      const cookies = document.cookie.split(";");
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        // Does this cookie string begin with the name we want?
        if (cookie.substring(0, name.length + 1) === name + "=") {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie("csrftoken");

  paypal
    .Buttons({
      // Call your backend to create the order
      createOrder: function (data, actions) {
        return fetch('{% url "payment_create_order" %}', {
          method: "post",
          headers: {
            "content-type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify({
            amount: "{{ amount }}", // Dynamic from context
            currency: "USD",
          }),
        })
          .then(function (res) {
            return res.json();
          })
          .then(function (orderData) {
            return orderData.id;
          });
      },

      // Call your backend to capture the order
      onApprove: function (data, actions) {
        return fetch('{% url "payment_capture_order" %}', {
          method: "post",
          headers: {
            "content-type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify({
            orderID: data.orderID,
          }),
        })
          .then(function (res) {
            return res.json();
          })
          .then(function (orderData) {
            if (orderData.redirect_url) {
              window.location.href = orderData.redirect_url;
            } else {
              const transaction =
                orderData.purchase_units[0].payments.captures[0];
              alert("Transaction completed by " + transaction.id);
            }
          });
      },
    })
    .render("#paypal-button-container");
</script>
{% endblock %}
