{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout | MiXiaomiUnlock{% endblock %}


{% block content %}
<div class="font-display animate-fade-in bg-[#F5F5F7] dark:bg-background-dark min-h-screen pt-8 pb-20">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
            <a href="{% url 'orders:cart_view' %}" class="hover:text-xiaomi transition-colors">Carrito</a>
            <span class="material-icons text-xs">chevron_right</span>
            <span class="text-gray-900 dark:text-white font-bold">Checkout</span>
        </div>

        <form method="post" action="." class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            {% csrf_token %}
            
            <!-- Left: Form -->
            <div class="lg:col-span-7 space-y-6">
                
                <!-- Shipping Info -->
                <div class="bg-white dark:bg-card-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 md:p-8">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="material-icons text-xiaomi">local_shipping</span>
                        Información de Envío
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Name -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Nombre Completo</label>
                            {{ form.shipping_name }}
                            {% if form.shipping_name.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_name.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Correo Electrónico</label>
                            {{ form.shipping_email }}
                             {% if form.shipping_email.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_email.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Phone -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Teléfono Móvil</label>
                            {{ form.shipping_phone }}
                             {% if form.shipping_phone.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_phone.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Address -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Dirección de Entrega</label>
                            {{ form.shipping_address }}
                             {% if form.shipping_address.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_address.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- City & Dept -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Ciudad</label>
                            {{ form.shipping_city }}
                             {% if form.shipping_city.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_city.errors.0 }}</p>
                            {% endif %}
                        </div>
                         <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Departamento</label>
                            {{ form.shipping_department }}
                             {% if form.shipping_department.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_department.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                         <!-- Postal Code -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Código Postal (Opcional)</label>
                            {{ form.shipping_postal_code }}
                        </div>
                    </div>
                </div>

                <!-- Payment Info -->
                <div class="bg-white dark:bg-card-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 md:p-8">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="material-icons text-xiaomi">payments</span>
                        Pago y Notas
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Método de Pago</label>
                            {{ form.payment_method }}
                             {% if form.payment_method.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.payment_method.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Notas del Pedido (Opcional)</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right: Order Summary -->
            <div class="lg:col-span-5 sticky top-24">
                <div class="bg-white dark:bg-card-dark rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800 p-6 md:p-8">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-6">Tu Pedido</h3>
                    
                    <!-- Items List (Scrollable if too long) -->
                    <div class="max-h-[300px] overflow-y-auto custom-scrollbar mb-6 pr-2 space-y-4">
                        {% for item in cart.items.all %}
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-gray-50 dark:bg-black/20 rounded-lg flex items-center justify-center border border-gray-100 dark:border-gray-800 flex-shrink-0 relative">

                                {% if item.product.image %}
                                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-10 h-10 object-contain">
                                {% else %}
                                    <span class="material-icons text-gray-300">image</span>
                                {% endif %}
                                <span class="absolute -top-2 -right-2 bg-gray-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full">{{ item.quantity }}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ item.product.name }}</h4>
                                <p class="text-xs text-gray-500">{{ item.product.category }}</p>
                            </div>
                            <div class="text-sm font-bold text-gray-900 dark:text-white">
                                ${{ item.get_total_price }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Totals -->
                    <div class="border-t border-gray-100 dark:border-gray-800 pt-4 space-y-3">
                         <div class="flex justify-between text-gray-500 dark:text-gray-400 text-sm">
                            <span>Subtotal</span>
                            <span>${{ cart.get_subtotal }}</span>
                        </div>
                        <div class="flex justify-between text-gray-500 dark:text-gray-400 text-sm">
                            <span>Impuestos (19%)</span>
                            <span>${{ cart.get_tax }}</span>
                        </div>
                        <div class="flex justify-between text-gray-500 dark:text-gray-400 text-sm">
                            <span>Envío</span>
                            <span class="text-green-500 font-bold">Gratis</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t border-gray-100 dark:border-gray-800 pt-4 mt-4">
                        <span class="text-lg font-bold text-gray-900 dark:text-white">Total a Pagar</span>
                        <span class="text-2xl font-bold text-primary dark:text-white">${{ cart.get_total }}</span>
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full mt-8 py-4 bg-primary dark:bg-white text-white dark:text-black rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-opacity-90 shadow-lg shadow-blue-500/20 active:scale-95 transition-all">
                        <span class="material-icons">lock</span>
                        Confirmar Compra
                    </button>
                    
                    <p class="text-center text-xs text-gray-400 mt-4 flex items-center justify-center gap-1">
                        <span class="material-icons text-xs">verified_user</span>
                        Tus datos están protegidos por encriptación SSL.
                    </p>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}
