{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout | MiXiaomiUnlock{% endblock %}

{% block extra_head %}
<!-- PayPal SDK -->
<script src="https://www.paypal.com/sdk/js?client-id={{ PAYPAL_CLIENT_ID }}&currency=USD"></script>
{% endblock %}


{% block content %}
<div class="font-display animate-fade-in bg-[#F5F5F7] dark:bg-background-dark min-h-screen pt-8 pb-20">
    <div class="max-w-[1200px] mx-auto px-4 sm:px-6 lg:px-8">
        
        <!-- Header -->
        <div class="mb-8 flex items-center gap-2 text-sm text-gray-500 dark:text-gray-400">
            <a href="{% url 'orders:cart_view' %}" class="hover:text-xiaomi transition-colors">Carrito</a>
            <span class="material-icons text-xs">chevron_right</span>
            <span class="text-gray-900 dark:text-white font-bold">Checkout</span>
        </div>

        <form id="checkout-form" method="post" action="." class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            {% csrf_token %}
            
            <!-- Left: Form -->
            <div class="lg:col-span-7 space-y-6">
                
                <!-- Shipping Info -->
                <div class="bg-white dark:bg-card-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 md:p-8">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="material-icons text-xiaomi">local_shipping</span>
                        Información de Envío
                    </h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Name -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Nombre Completo</label>
                            {{ form.shipping_name }}
                            {% if form.shipping_name.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_name.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Email -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Correo Electrónico</label>
                            {{ form.shipping_email }}
                             {% if form.shipping_email.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_email.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Phone -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Teléfono Móvil</label>
                            {{ form.shipping_phone }}
                             {% if form.shipping_phone.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_phone.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- Address -->
                        <div class="md:col-span-2">
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Dirección de Entrega</label>
                            {{ form.shipping_address }}
                             {% if form.shipping_address.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_address.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <!-- City & Dept -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Ciudad</label>
                            {{ form.shipping_city }}
                             {% if form.shipping_city.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_city.errors.0 }}</p>
                            {% endif %}
                        </div>
                         <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Departamento</label>
                            {{ form.shipping_department }}
                             {% if form.shipping_department.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.shipping_department.errors.0 }}</p>
                            {% endif %}
                        </div>
                        
                         <!-- Postal Code -->
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Código Postal (Opcional)</label>
                            {{ form.shipping_postal_code }}
                        </div>
                    </div>
                </div>

                <!-- Payment Info -->
                <div class="bg-white dark:bg-card-dark rounded-2xl shadow-sm border border-gray-100 dark:border-gray-800 p-6 md:p-8">
                    <h2 class="text-xl font-bold text-gray-900 dark:text-white mb-6 flex items-center gap-2">
                        <span class="material-icons text-xiaomi">payments</span>
                        Pago y Notas
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Método de Pago</label>
                            {{ form.payment_method }}
                             {% if form.payment_method.errors %}
                                <p class="text-red-500 text-xs mt-1">{{ form.payment_method.errors.0 }}</p>
                            {% endif %}
                        </div>

                        <div>
                            <label class="block text-sm font-bold text-gray-700 dark:text-gray-300 mb-1">Notas del Pedido (Opcional)</label>
                            {{ form.notes }}
                        </div>
                    </div>
                </div>

            </div>

            <!-- Right: Order Summary -->
            <div class="lg:col-span-5 sticky top-24">
                <div class="bg-white dark:bg-card-dark rounded-2xl shadow-lg border border-gray-100 dark:border-gray-800 p-6 md:p-8">
                    <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-6">Tu Pedido</h3>
                    
                    <!-- Items List (Scrollable if too long) -->
                    <div class="max-h-[300px] overflow-y-auto custom-scrollbar mb-6 pr-2 space-y-4">
                        {% for item in cart.items.all %}
                        <div class="flex items-center gap-4">
                            <div class="w-14 h-14 bg-gray-50 dark:bg-black/20 rounded-lg flex items-center justify-center border border-gray-100 dark:border-gray-800 flex-shrink-0 relative">

                                {% if item.product.image %}
                                    <img src="{{ item.product.image.url }}" alt="{{ item.product.name }}" class="w-10 h-10 object-contain">
                                {% else %}
                                    <span class="material-icons text-gray-300">image</span>
                                {% endif %}
                                <span class="absolute -top-2 -right-2 bg-gray-500 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full">{{ item.quantity }}</span>
                            </div>
                            <div class="flex-1 min-w-0">
                                <h4 class="text-sm font-medium text-gray-900 dark:text-white truncate">{{ item.product.name }}</h4>
                                <p class="text-xs text-gray-500">{{ item.product.category }}</p>
                            </div>
                            <div class="text-sm font-bold text-gray-900 dark:text-white">
                                ${{ item.get_total_price }}
                            </div>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Totals -->
                    <div class="border-t border-gray-100 dark:border-gray-800 pt-4 space-y-3">
                         <div class="flex justify-between text-gray-500 dark:text-gray-400 text-sm">
                            <span>Subtotal</span>
                            <span>${{ cart.get_subtotal }}</span>
                        </div>
                        <div class="flex justify-between text-gray-500 dark:text-gray-400 text-sm">
                            <span>Impuestos (19%)</span>
                            <span>${{ cart.get_tax }}</span>
                        </div>
                        <div class="flex justify-between text-gray-500 dark:text-gray-400 text-sm">
                            <span>Envío</span>
                            <span class="text-green-500 font-bold">Gratis</span>
                        </div>
                    </div>

                    <div class="flex justify-between items-center border-t border-gray-100 dark:border-gray-800 pt-4 mt-4">
                        <span class="text-lg font-bold text-gray-900 dark:text-white">Total a Pagar</span>
                        <span class="text-2xl font-bold text-primary dark:text-white">${{ cart.get_total }}</span>
                    </div>

                    <!-- Submit Buttons -->
                    <button type="submit" id="submit-button" class="w-full mt-8 py-4 bg-primary dark:bg-white text-white dark:text-black rounded-xl font-bold flex items-center justify-center gap-2 hover:bg-opacity-90 shadow-lg shadow-blue-500/20 active:scale-95 transition-all">
                        <span class="material-icons">lock</span>
                        Confirmar Compra
                    </button>
                    
                    <!-- PayPal Buttons Container (Initially Hidden) -->
                    <div id="paypal-button-container" class="w-full mt-8" style="display: none;"></div>
                    
                    <p class="text-center text-xs text-gray-400 mt-4 flex items-center justify-center gap-1">
                        <span class="material-icons text-xs">verified_user</span>
                        Tus datos están protegidos por encriptación SSL.
                    </p>
                </div>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// PayPal Integration Script
document.addEventListener('DOMContentLoaded', function() {
    const checkoutForm = document.getElementById('checkout-form');
    const submitButton = document.getElementById('submit-button');
    const paypalContainer = document.getElementById('paypal-button-container');
    const paymentMethodSelect = document.querySelector('[name="payment_method"]');
    
    // Función para mostrar/ocultar botones según método de pago
    function updatePaymentUI() {
        const paymentMethod = paymentMethodSelect ? paymentMethodSelect.value : '';
        
        if (paymentMethod === 'PAYPAL') {
            // Mostrar botones PayPal, ocultar botón submit
            submitButton.style.display = 'none';
            paypalContainer.style.display = 'block';
        } else {
            // Mostrar botón submit, ocultar PayPal
            submitButton.style.display = 'flex';
            paypalContainer.style.display = 'none';
        }
    }
    
    // Escuchar cambios en el método de pago
    if (paymentMethodSelect) {
        paymentMethodSelect.addEventListener('change', updatePaymentUI);
        updatePaymentUI(); // Inicializar en carga
    }
    
    // Inicializar botones de PayPal
    if (typeof paypal !== 'undefined') {
        paypal.Buttons({
            // onClick se ejecuta antes de que PayPal inicie el proceso de pago
            onClick: function(data, actions) {
                // Validación básica del formulario en el cliente
                const requiredFields = ['shipping_name', 'shipping_email', 'shipping_phone', 'shipping_address', 'shipping_city'];
                let isValid = true;
                
                for (let field of requiredFields) {
                    const el = checkoutForm.querySelector(`[name="${field}"]`);
                    if (!el || !el.value.trim()) {
                        el.classList.add('border-red-500', 'ring-1', 'ring-red-500');
                        isValid = false;
                    } else {
                        el.classList.remove('border-red-500', 'ring-1', 'ring-red-500');
                    }
                }
                
                if (!isValid) {
                    alert('Por favor completa todos los campos requeridos antes de proceder con PayPal.');
                    return actions.reject();
                }
                return actions.resolve();
            },

            // Crear orden en backend
            createOrder: function(data, actions) {
                const formData = new FormData(checkoutForm);
                formData.append('use_paypal', 'true');
                formData.append('payment_method', 'PAYPAL');
                
                // Unificamos todo en una sola petición al endpoint de creación de orden
                // Esto elimina la latencia de peticiones secuenciales
                return fetch('/payment/create/', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                    },
                    body: formData // Enviamos el FormData completo
                })
                .then(res => {
                    if (!res.ok) {
                        return res.json().then(data => {
                            throw new Error(data.error || 'Error al procesar la orden');
                        });
                    }
                    return res.json();
                })
                .then(data => {
                    if (data.success && data.order_id) {
                        return data.order_id;
                    } else {
                        throw new Error(data.error || 'No se pudo obtener el ID de orden');
                    }
                })
                .catch(error => {
                    console.error('PayPal Order Error:', error);
                    alert('Error al iniciar PayPal: ' + error.message);
                });
            },
            
            // Capturar pago después de aprobación
            onApprove: function(data, actions) {
                const csrfToken = document.querySelector('[name="csrfmiddlewaretoken"]').value;
                
                return fetch(`/payment/capture/${data.orderID}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': csrfToken
                    }
                })
                .then(res => res.json())
                .then(data => {
                    if (data.status === 'success') {
                        // Redirigir a página de éxito
                        window.location.href = '/orders/success/';
                    } else {
                        alert('Error al procesar el pago: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error al capturar pago');
                });
            },
            
            // Manejar cancelación
            onCancel: function(data) {
                console.log('Pago cancelado', data);
                alert('Has cancelado el pago. Puedes intentar nuevamente.');
            },
            
            // Manejar errores
            onError: function(err) {
                console.error('Error de PayPal:', err);
                alert('Ocurrió un error con PayPal. Por favor intenta nuevamente.');
            },
            
            // Estilo de los botones
            style: {
                layout: 'vertical',
                color: 'blue',
                shape: 'rect',
                label: 'paypal',
                height: 50
            }
        }).render('#paypal-button-container');
    }
});
</script>
{% endblock %}
